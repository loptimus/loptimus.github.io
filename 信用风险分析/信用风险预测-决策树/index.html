<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta charset="UTF-8"><meta name="generator" content="Hexo 3.9.0"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0"><link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222"><link rel="stylesheet" href="/css/main.css?v=7.3.0"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"7.3.0",sidebar:{position:"left",display:"post",offset:12,onmobile:!1},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},copycode:{enable:!1,show_result:!1,style:null},fancybox:!1,mediumzoom:!0,lazyload:!0,pangu:!1,algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},search:{root:"/",path:"search.xml"},tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"复制",copy_success:"复制成功",copy_failure:"复制失败"}}</script><meta name="description" content="信用风险预测-决策树"><meta name="keywords" content="R语言,决策树"><meta property="og:type" content="article"><meta property="og:title" content="信用风险预测-决策树"><meta property="og:url" content="http://yoursite.com/信用风险分析/信用风险预测-决策树/index.html"><meta property="og:site_name" content="QuickNotes"><meta property="og:description" content="信用风险预测-决策树"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2019-08-02T06:16:08.252Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="信用风险预测-决策树"><meta name="twitter:description" content="信用风险预测-决策树"><link rel="canonical" href="http://yoursite.com/信用风险分析/信用风险预测-决策树/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>信用风险预测-决策树 | QuickNotes</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">QuickNotes</span><span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益 404</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header> <a href="https://github.com/loptimus" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/信用风险分析/信用风险预测-决策树/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="lwl"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="QuickNotes"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">信用风险预测-决策树</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-02-26 17:34:47" itemprop="dateCreated datePublished" datetime="2019-02-26T17:34:47+08:00">2019-02-26</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-08-02 14:16:08" itemprop="dateModified" datetime="2019-08-02T14:16:08+08:00">2019-08-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/信用风险分析/" itemprop="url" rel="index"><span itemprop="name">信用风险分析</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数：<span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span></span><br><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">7.1k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">1 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="信用风险预测-决策树">信用风险预测-决策树</h1><a id="more"></a><h2 id="预测工具准备">预测工具准备</h2><ul><li>需要用到的R package</li></ul><table><thead><tr class="header"><th>package</th><th>描述</th></tr></thead><tbody><tr class="odd"><td>rpart</td><td>树模型</td></tr><tr class="even"><td>rpart.plot</td><td>树模型可视化</td></tr><tr class="odd"><td>ggplot2</td><td>数据可视化</td></tr><tr class="even"><td>caret</td><td>分类和回归训练</td></tr><tr class="odd"><td>ROCR</td><td>ROC曲线</td></tr></tbody></table><p>分析开始时，可先将所需要的package安装并加载到R环境中。</p><ul><li>所使用的自定义的工具函数</li></ul><p>本文所使用的所有自定义的工具函数都放在名为"dt_utils.R"的文件中。分析开始时，可先将该文件加载到R环境中。假设文件"dt_utils.R"在当前的工作环境目录下，可使用source函数加载该文件内容。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载dt_utils.R</span></span><br><span class="line"><span class="keyword">source</span>(<span class="string">"dt_utils.R"</span>)</span><br></pre></td></tr></table></figure><blockquote><p><a href="dt_utils.R">dt_utils.R</a></p></blockquote><h2 id="数据处理">数据处理</h2><h3 id="数据来源">数据来源</h3><p>本文将使用<a href="../信用风险分析/">信用风险分析</a>里处理过后的数据进行建模预测和模型评估。</p><blockquote><p>原始数据来自kaggle：<a href="https://www.kaggle.com/kabure/german-credit-data-with-risk" target="_blank" rel="noopener">kaggle.com/kabure/german-credit-data-with-risk</a></p></blockquote><h3 id="标准化和归一化">标准化和归一化</h3><p>对数据集中的特征Age、Credit.amount、Duration进行标准化和归一化。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">numeric.vars &lt;- c(<span class="string">"Duration"</span>, <span class="string">"Age"</span>, <span class="string">"Credit.amount"</span>)</span><br><span class="line">credit.df.full &lt;- scale.features(credit.df.full, numeric.vars)</span><br></pre></td></tr></table></figure><h2 id="划分数据集">划分数据集</h2><p>按照信用风险变量进行等比例抽样划分训练集和测试集。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(prop.table(table(credit.df.full$Risk)))</span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0</span>   <span class="number">1</span> </span><br><span class="line"><span class="number">0.3</span> <span class="number">0.7</span></span><br></pre></td></tr></table></figure><p>信用风险为差的比例为0.3，信用风险为好的比例为0.7，所以训练集和测试集中信用风险差和好的比例也分别为0.3、0.7。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 等比例划分训练集和测试集</span></span><br><span class="line">idx &lt;- createDataPartition(credit.df.full$Risk, times = <span class="number">1</span>, p = <span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">train.data &lt;- credit.df.full[idx, ]  <span class="comment"># 训练集</span></span><br><span class="line">test.data &lt;- credit.df.full[-idx, ]  <span class="comment"># 测试集</span></span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(prop.table(table(train.data$Risk)))  <span class="comment"># 查看训练集信用风险比例</span></span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0</span>   <span class="number">1</span> </span><br><span class="line"><span class="number">0.3</span> <span class="number">0.7</span></span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(prop.table(table(test.data$Risk)))  <span class="comment"># 查看测试集信用风险比例</span></span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0</span>   <span class="number">1</span> </span><br><span class="line"><span class="number">0.3</span> <span class="number">0.7</span></span><br></pre></td></tr></table></figure><h2 id="建立模型与评估模型">建立模型与评估模型</h2><p>划分测试特征和目标特征</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试特征</span></span><br><span class="line">test.feature &lt;- test.data[, -<span class="number">1</span>]</span><br><span class="line"><span class="comment"># 测试的目标特征</span></span><br><span class="line">test.feature.target &lt;- test.data[, <span class="number">1</span>]</span><br></pre></td></tr></table></figure><h3 id="决策树模型">决策树模型</h3><p>使用训练集的所有特征创建决策树模型，并查看模型信息。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dt.model.all &lt;- rpart(</span><br><span class="line">  formula = as.formula(<span class="string">"Risk ~ ."</span>), method = <span class="string">"class"</span>, </span><br><span class="line">  data = train.data,</span><br><span class="line">  control = rpart.control(cp = <span class="number">0.05</span>)</span><br><span class="line">)</span><br><span class="line"><span class="comment"># 查看模型信息</span></span><br><span class="line">summary(dt.model.all)</span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Call:</span><br><span class="line">rpart(formula = as.formula(<span class="string">"Risk ~ ."</span>), data = train.data, method = <span class="string">"class"</span>, </span><br><span class="line">    control = rpart.control(cp = <span class="number">0.05</span>))</span><br><span class="line">  n= <span class="number">700</span> </span><br><span class="line"></span><br><span class="line">          CP nsplit rel error xerror xstd</span><br><span class="line"><span class="number">1</span> <span class="number">0.03095238</span>      <span class="number">0</span>         <span class="number">1</span>      <span class="number">0</span>    <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Node number <span class="number">1</span>: <span class="number">700</span> observations</span><br><span class="line">  predicted class=<span class="number">1</span>  expected loss=<span class="number">0.3</span>  P(node) =<span class="number">1</span></span><br><span class="line">    class counts:   <span class="number">210</span>   <span class="number">490</span></span><br><span class="line">   probabilities: <span class="number">0.300</span> <span class="number">0.700</span></span><br></pre></td></tr></table></figure><p>使用测试集进行预测，并查看预测结果。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dt.predictions.all &lt;- predict(</span><br><span class="line">  dt.model.all, test.feature, type = <span class="string">"prob"</span></span><br><span class="line">)</span><br><span class="line">(dt.all.conf.matrix &lt;- confusionMatrix(</span><br><span class="line">  as.factor(round(dt.predictions.all[, <span class="number">2</span>])),</span><br><span class="line">  test.feature.target, positive = <span class="string">"1"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Confusion Matrix and Statistics</span><br><span class="line"></span><br><span class="line">          Reference</span><br><span class="line">Prediction   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">         <span class="number">0</span>   <span class="number">0</span>   <span class="number">0</span></span><br><span class="line">         <span class="number">1</span>  <span class="number">90</span> <span class="number">210</span></span><br><span class="line">                                          </span><br><span class="line">               Accuracy : <span class="number">0.7</span>             </span><br><span class="line">                 <span class="number">95</span>% CI : (<span class="number">0.6447</span>, <span class="number">0.7513</span>)</span><br><span class="line">    No Information Rate : <span class="number">0.7</span>             </span><br><span class="line">    P-Value [Acc &gt; NIR] : <span class="number">0.5284</span>          </span><br><span class="line">                                          </span><br><span class="line">                  Kappa : <span class="number">0</span>               </span><br><span class="line">                                          </span><br><span class="line"> Mcnemar<span class="string">'s Test P-Value : &lt;2e-16          </span></span><br><span class="line"><span class="string">                                          </span></span><br><span class="line"><span class="string">            Sensitivity : 1.0             </span></span><br><span class="line"><span class="string">            Specificity : 0.0             </span></span><br><span class="line"><span class="string">         Pos Pred Value : 0.7             </span></span><br><span class="line"><span class="string">         Neg Pred Value : NaN             </span></span><br><span class="line"><span class="string">             Prevalence : 0.7             </span></span><br><span class="line"><span class="string">         Detection Rate : 0.7             </span></span><br><span class="line"><span class="string">   Detection Prevalence : 1.0             </span></span><br><span class="line"><span class="string">      Balanced Accuracy : 0.5             </span></span><br><span class="line"><span class="string">                                          </span></span><br><span class="line"><span class="string">       '</span>Positive<span class="string">' Class : 1               </span></span><br><span class="line"><span class="string">                                          </span></span><br><span class="line"><span class="string">[1] 0.8235</span></span><br></pre></td></tr></table></figure><p>这是一个过于激进的模型，将所有的客户都预测称信用风险好的客户。</p><h3 id="交叉验证">交叉验证</h3><p>使用K = 10折交叉验证进行分析，并调整类别权重。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dt.model.cv &lt;- rpart(</span><br><span class="line">  formula = as.formula(<span class="string">"Risk ~ ."</span>), method = <span class="string">"class"</span>, </span><br><span class="line">  data = train.data,</span><br><span class="line">  control = rpart.control(cp = <span class="number">0.05</span>, xval = <span class="number">10</span>),</span><br><span class="line">  parms = list(prior = c(<span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">)</span><br><span class="line"><span class="comment"># 查看模型信息</span></span><br><span class="line">summary(dt.model.cv)</span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Call:</span><br><span class="line">rpart(formula = as.formula(<span class="string">"Risk ~ ."</span>), data = train.data, method = <span class="string">"class"</span>, </span><br><span class="line">    parms = list(prior = c(<span class="number">0.5</span>, <span class="number">0.5</span>)), control = rpart.control(cp = <span class="number">0.05</span>, </span><br><span class="line">        xval = <span class="number">10</span>))</span><br><span class="line">  n= <span class="number">700</span> </span><br><span class="line"></span><br><span class="line">         CP nsplit rel error    xerror       xstd</span><br><span class="line"><span class="number">1</span> <span class="number">0.1659864</span>      <span class="number">0</span> <span class="number">1.0000000</span> <span class="number">1.1156463</span> <span class="number">0.04251409</span></span><br><span class="line"><span class="number">2</span> <span class="number">0.0500000</span>      <span class="number">1</span> <span class="number">0.8340136</span> <span class="number">0.8707483</span> <span class="number">0.04850215</span></span><br><span class="line"></span><br><span class="line">Variable importance</span><br><span class="line">     Duration Credit.amount </span><br><span class="line">           <span class="number">81</span>            <span class="number">19</span> </span><br><span class="line"></span><br><span class="line">Node number <span class="number">1</span>: <span class="number">700</span> observations,    complexity param=<span class="number">0.1659864</span></span><br><span class="line">  predicted class=<span class="number">0</span>  expected loss=<span class="number">0.5</span>  P(node) =<span class="number">1</span></span><br><span class="line">    class counts:   <span class="number">210</span>   <span class="number">490</span></span><br><span class="line">   probabilities: <span class="number">0.500</span> <span class="number">0.500</span> </span><br><span class="line">  left son=<span class="number">2</span> (<span class="number">122</span> obs) right son=<span class="number">3</span> (<span class="number">578</span> obs)</span><br><span class="line">  Primary splits:</span><br><span class="line">      Duration        &lt; <span class="number">0.8787763</span>  to the right, improve=<span class="number">14.660940</span>, (<span class="number">0</span> missing)</span><br><span class="line">      Credit.amount   &lt; <span class="number">1.042514</span>   to the right, improve= <span class="number">9.998117</span>, (<span class="number">0</span> missing)</span><br><span class="line">      Saving.accounts splits as  LLRR, improve= <span class="number">8.421415</span>, (<span class="number">0</span> missing)</span><br><span class="line">      Housing         splits as  LRL, improve= <span class="number">7.774902</span>, (<span class="number">0</span> missing)</span><br><span class="line">      Age             &lt; -<span class="number">0.8831285</span> to the left,  improve= <span class="number">6.017898</span>, (<span class="number">0</span> missing)</span><br><span class="line">  Surrogate splits:</span><br><span class="line">      Credit.amount &lt; <span class="number">1.278278</span>   to the right, agree=<span class="number">0.866</span>, adj=<span class="number">0.23</span>, (<span class="number">0</span> split)</span><br><span class="line"></span><br><span class="line">Node number <span class="number">2</span>: <span class="number">122</span> observations</span><br><span class="line">  predicted class=<span class="number">0</span>  expected loss=<span class="number">0.3</span>  P(node) =<span class="number">0.207483</span></span><br><span class="line">    class counts:    <span class="number">61</span>    <span class="number">61</span></span><br><span class="line">   probabilities: <span class="number">0.700</span> <span class="number">0.300</span> </span><br><span class="line"></span><br><span class="line">Node number <span class="number">3</span>: <span class="number">578</span> observations</span><br><span class="line">  predicted class=<span class="number">1</span>  expected loss=<span class="number">0.4476395</span>  P(node) =<span class="number">0.792517</span></span><br><span class="line">    class counts:   <span class="number">149</span>   <span class="number">429</span></span><br><span class="line">   probabilities: <span class="number">0.448</span> <span class="number">0.552</span></span><br></pre></td></tr></table></figure><p>可视化该决策树模型</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prp(dt.model.cv, type = <span class="number">1</span>, extra = <span class="number">3</span>, varlen = <span class="number">0</span>, faclen = <span class="number">0</span>)</span><br></pre></td></tr></table></figure> <img title="决策树可视化" data-src="/信用风险分析/信用风险预测-决策树/dt_view.jpg"><p>对测试集进行预测，并查看预测结果。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dt.predictions.cv &lt;- predict(dt.model.cv, test.feature, type = <span class="string">"prob"</span>)</span><br><span class="line">(dt.imp.conf.matrix &lt;- confusionMatrix(</span><br><span class="line">  data = as.factor(round(dt.predictions.cv[, <span class="number">2</span>])), </span><br><span class="line">  reference = test.feature.target, </span><br><span class="line">  positive = <span class="string">"1"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Confusion Matrix and Statistics</span><br><span class="line"></span><br><span class="line">          Reference</span><br><span class="line">Prediction   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">         <span class="number">0</span>  <span class="number">22</span>  <span class="number">29</span></span><br><span class="line">         <span class="number">1</span>  <span class="number">68</span> <span class="number">181</span></span><br><span class="line">                                          </span><br><span class="line">               Accuracy : <span class="number">0.6767</span>          </span><br><span class="line">                 <span class="number">95</span>% CI : (<span class="number">0.6205</span>, <span class="number">0.7293</span>)</span><br><span class="line">    No Information Rate : <span class="number">0.7</span>             </span><br><span class="line">    P-Value [Acc &gt; NIR] : <span class="number">0.8278928</span>       </span><br><span class="line">                                          </span><br><span class="line">                  Kappa : <span class="number">0.1214</span>          </span><br><span class="line">                                          </span><br><span class="line"> Mcnemar<span class="string">'s Test P-Value : 0.0001142       </span></span><br><span class="line"><span class="string">                                          </span></span><br><span class="line"><span class="string">            Sensitivity : 0.8619          </span></span><br><span class="line"><span class="string">            Specificity : 0.2444          </span></span><br><span class="line"><span class="string">         Pos Pred Value : 0.7269          </span></span><br><span class="line"><span class="string">         Neg Pred Value : 0.4314          </span></span><br><span class="line"><span class="string">             Prevalence : 0.7000          </span></span><br><span class="line"><span class="string">         Detection Rate : 0.6033          </span></span><br><span class="line"><span class="string">   Detection Prevalence : 0.8300          </span></span><br><span class="line"><span class="string">      Balanced Accuracy : 0.5532          </span></span><br><span class="line"><span class="string">                                          </span></span><br><span class="line"><span class="string">       '</span>Positive<span class="string">' Class : 1</span></span><br></pre></td></tr></table></figure><p>计算F1 score</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">calc.f1.score(dt.cv.conf.matrix)</span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>] <span class="number">0.7887</span></span><br></pre></td></tr></table></figure><p>预测的结果的准确度为0.6767，灵敏度为0.8619，特异性为0.2444，F1 score为0.7887。这说明模型能够很好地预测信用风险好的客户，但对信用风险差的客户的预测效果并不理想。</p><h3 id="模型选择">模型选择</h3><p>绘制ROC曲线，比较两个模型的AUC。</p><h4 id="roc曲线">ROC曲线</h4><p>使用所有特征的决策树模型的ROC曲线</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dt.all.pred &lt;- prediction(</span><br><span class="line">  dt.predictions.all[, <span class="number">2</span>], test.feature.target</span><br><span class="line">)</span><br><span class="line">par(mfrow = c(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">plot.roc.curve(dt.all.pred, title.text = <span class="string">"决策树ROC曲线"</span>)</span><br><span class="line">plot.pr.curve(dt.all.pred, title.text = <span class="string">"决策树Precision/Recall曲线"</span>)</span><br></pre></td></tr></table></figure> <img title="所有特征的决策树的ROC曲线" data-src="/信用风险分析/信用风险预测-决策树/dt_all_roc.jpg"><p>交叉验证并调整分类权重决策树模型的ROC曲线</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dt.cv.pred &lt;- prediction(</span><br><span class="line">  dt.predictions.cv[, <span class="number">2</span>], test.feature.target</span><br><span class="line">)</span><br><span class="line">par(mfrow = c(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">plot.roc.curve(dt.cv.pred, title.text = <span class="string">"决策树ROC曲线"</span>)</span><br><span class="line">plot.pr.curve(dt.cv.pred, title.text = <span class="string">"决策树Precision/Recall曲线"</span>)</span><br></pre></td></tr></table></figure> <img title="交叉验证并调整分类权重决策树模型的ROC曲线" data-src="/信用风险分析/信用风险预测-决策树/dt_cv_roc.jpg"><p>模型评估指标</p><table><thead><tr class="header"><th>模型</th><th>准确度</th><th>灵敏度</th><th>特异性</th><th>F1 score</th><th>AUC值</th></tr></thead><tbody><tr class="odd"><td>所有特征的决策树模型</td><td>0.7</td><td>1</td><td>0</td><td>0.8235</td><td>0.5</td></tr><tr class="even"><td>交叉验证调整分类权重决策树模型</td><td>0.6767</td><td>0.8619</td><td>0.2444</td><td>0.7887</td><td>0.55</td></tr></tbody></table><p>至于选择哪个模型用于预测，并不完全依赖于模型的准确度，而是根据研究领域和业务需求来决定。如果模型将一个信用评级差的客户预测为信用评级好的客户，这意味着银行将批准一名最终违约的客户的贷款申请，这将导致银行的损失。但是，如果模型将一个信用评级好的客户预测为信用评级差的客户，这意味着银行将否决该客户的的贷款申请，银行将既不会盈利也不会有所损失。所以基于损失最小化，利益最大化的原则，这里将选用特异性较大的模型，即交叉验证调整分类权重决策树模型。</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/R语言/" rel="tag"><i class="fa fa-tag"></i> R语言</a><a href="/tags/决策树/" rel="tag"><i class="fa fa-tag"></i> 决策树</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/信用风险分析/信用风险预测-逻辑回归/" rel="next" title="信用风险预测-逻辑回归"><i class="fa fa-chevron-left"></i> 信用风险预测-逻辑回归</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/信用风险分析/信用风险预测-svm/" rel="prev" title="信用风险预测-SVM">信用风险预测-SVM<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">lwl</p><div class="site-description motion-element" itemprop="description"></div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">18</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">24</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#信用风险预测-决策树"><span class="nav-number">1.</span> <span class="nav-text">信用风险预测-决策树</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#预测工具准备"><span class="nav-number">1.1.</span> <span class="nav-text">预测工具准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据处理"><span class="nav-number">1.2.</span> <span class="nav-text">数据处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据来源"><span class="nav-number">1.2.1.</span> <span class="nav-text">数据来源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#标准化和归一化"><span class="nav-number">1.2.2.</span> <span class="nav-text">标准化和归一化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#划分数据集"><span class="nav-number">1.3.</span> <span class="nav-text">划分数据集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立模型与评估模型"><span class="nav-number">1.4.</span> <span class="nav-text">建立模型与评估模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#决策树模型"><span class="nav-number">1.4.1.</span> <span class="nav-text">决策树模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#交叉验证"><span class="nav-number">1.4.2.</span> <span class="nav-text">交叉验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模型选择"><span class="nav-number">1.4.3.</span> <span class="nav-text">模型选择</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#roc曲线"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">ROC曲线</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">lwl</span></div><div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div> <span class="post-meta-divider">|</span><div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script src="/lib/jquery/index.js?v=3.4.1"></script><script src="/lib/mediumzoom/medium-zoom.min.js"></script><script src="/lib/lazyload/lozad.min.js?v=1.10.0"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.3.0"></script><script src="/js/motion.js?v=7.3.0"></script><script src="/js/affix.js?v=7.3.0"></script><script src="/js/schemes/pisces.js?v=7.3.0"></script><script src="/js/scrollspy.js?v=7.3.0"></script><script src="/js/post-details.js?v=7.3.0"></script><script src="/js/next-boot.js?v=7.3.0"></script><script src="/js/local-search.js?v=7.3.0"></script><script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script><script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script></body></html>